---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { Hammer, Droplet, Zap, Home } from "@lucide/astro";
import HeroImage1 from "@/assets/Maintenance_home.webp";
import HeroImage2 from "@/assets/Plumbing_Services.webp";
import HeroImage3 from "@/assets/Drywall_repair.webp";
interface Slide {
  src: ImageMetadata;
  alt: string;
}

interface Feature {
  icon: any;
  label: string;
}

const slides: Slide[] = [
  {
    src: HeroImage1,
    alt: "Professional Home Maintenance Services in Ogden",
  },
  {
    src: HeroImage2,
    alt: "Expert Plumbing and Repair Services in Ogden",
  },
  {
    src: HeroImage3,
    alt: "Professional Drywall Installation and Repair in Utah",
  },
];

const features: Feature[] = [
  { icon: Hammer, label: "Drywall" },
  { icon: Droplet, label: "Plumbing" },
  { icon: Zap, label: "Electrical" },
  { icon: Home, label: "Maintenance" },
];
---

<section
  id="hero"
  data-hero-container
  class="relative w-full h-svh min-h-[600px] md:h-[800px] text-white overflow-hidden"
>
  <div class="absolute inset-0 z-0 select-none pointer-events-none">
    {
      slides.map((slide, i) => (
        <Image
          src={slide.src}
          alt={slide.alt}
          data-hero-slide
          class={`absolute inset-0 w-full h-full object-cover ${i === 0 ? "opacity-100" : "opacity-0"}`}
          loading={i === 0 ? "eager" : "lazy"}
          {...(i === 0 ? { fetchpriority: "high" } : {})}
        />
      ))
    }
    <div class="absolute inset-0 bg-black/50"></div>
  </div>

  <div
    class="relative z-10 flex flex-col items-center justify-center h-full px-4 sm:px-6 md:px-12 text-center pt-10 md:pt-20"
  >
    <div class="max-w-4xl space-y-6 md:space-y-8">
      <h1
        data-animate-title
        class="text-4xl sm:text-5xl md:text-7xl font-bold font-inter leading-tight tracking-tight"
      >
        Your Trusted Ogden Handyman & <span class="text-orange-500"
          >Support</span
        >
      </h1>

      <p
        data-animate-subtitle
        class="text-lg md:text-2xl font-roboto max-w-2xl mx-auto text-gray-200"
      >
        Expert home repair and maintenance for homeowners and landlords in
        Ogden.
      </p>

      <div
        data-animate-cta
        class="flex flex-col sm:flex-row gap-4 justify-center pt-2 md:pt-4 w-full sm:w-auto px-4 sm:px-0"
      >
        <a
          href="/contact"
          class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white py-4 px-10 rounded-xl font-semibold shadow-lg transition-all hover:scale-105 active:scale-95 text-center"
        >
          Get an Estimate
        </a>
        <a
          href="/services"
          class="w-full sm:w-auto bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/30 text-white py-4 px-10 rounded-xl font-semibold transition-all hover:border-white text-center"
        >
          Explore Our Services
        </a>
      </div>

      <div
        data-animate-icons
        class="flex flex-wrap gap-4 md:gap-6 pt-6 md:pt-8 justify-center"
      >
        {
          features.map(({ icon: Icon, label }) => (
            <div class="flex items-center gap-3 bg-black/20 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10 will-change-transform">
              <Icon class="w-5 h-5 text-orange-500" />
              <span class="font-roboto font-medium text-xs md:text-base">
                {label}
              </span>
            </div>
          ))
        }
      </div>
    </div>
  </div>

  <div
    class="absolute bottom-6 md:bottom-10 left-1/2 -translate-x-1/2 z-20 flex gap-3"
  >
    {
      slides.map((_, i) => (
        <button
          data-hero-dot
          data-index={i}
          class={`w-3 h-3 rounded-full transition-all duration-300 ${i === 0 ? "bg-white scale-125" : "bg-white/40 hover:bg-white/60"}`}
          aria-label={`Go to slide ${i + 1}`}
        />
      ))
    }
  </div>
</section>

<style>
  [data-animate-title],
  [data-animate-subtitle],
  [data-animate-cta],
  [data-animate-icons] > div {
    opacity: 0;
    transform: translateY(20px);
    visibility: visible; /* Changed from hidden to avoid JS execution block */
  }

  /* Entrance Animations */
  .hero-animated [data-animate-title] {
    animation: fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    animation-delay: 0.1s;
  }
  .hero-animated [data-animate-subtitle] {
    animation: fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    animation-delay: 0.2s;
  }
  .hero-animated [data-animate-cta] {
    animation: fadeUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    animation-delay: 0.3s;
  }
  .hero-animated [data-animate-icons] > div {
    animation: fadeUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }
  .hero-animated [data-animate-icons] > div:nth-child(1) {
    animation-delay: 0.4s;
  }
  .hero-animated [data-animate-icons] > div:nth-child(2) {
    animation-delay: 0.45s;
  }
  .hero-animated [data-animate-icons] > div:nth-child(3) {
    animation-delay: 0.5s;
  }
  .hero-animated [data-animate-icons] > div:nth-child(4) {
    animation-delay: 0.55s;
  }

  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  import gsap from "gsap";

  function setupHero() {
    const containers = document.querySelectorAll("[data-hero-container]");

    containers.forEach((container) => {
      // Trigger CSS animations immediately
      container.classList.add("hero-animated");

      const existingInterval = (container as any)._heroInterval;
      if (existingInterval) clearInterval(existingInterval);

      const slides = container.querySelectorAll(
        "[data-hero-slide]",
      ) as NodeListOf<HTMLElement>;
      const dots = container.querySelectorAll(
        "[data-hero-dot]",
      ) as NodeListOf<HTMLElement>;

      if (slides.length === 0) return;

      let current = 0;
      const total = slides.length;
      let interval: ReturnType<typeof setInterval> | undefined;
      const isMobile = window.innerWidth < 768;

      function goToSlide(slideIndex: number) {
        if (slideIndex === current) return;
        const prev = current;
        current = slideIndex;

        if (isMobile) {
          gsap.to(slides[prev], { opacity: 0, duration: 0.8 });
          gsap.to(slides[current], { opacity: 1, duration: 0.8 });
        } else {
          gsap.to(slides[prev], { opacity: 0, scale: 1.02, duration: 1 });
          gsap.fromTo(
            slides[current],
            { opacity: 0, scale: 1.05 },
            { opacity: 1, scale: 1, duration: 1.2, ease: "power2.out" },
          );
        }

        dots.forEach((dot, idx) => {
          if (idx === current) {
            dot.classList.remove("bg-white/40", "bg-white/60");
            dot.classList.add("bg-white", "scale-125");
          } else {
            dot.classList.remove("bg-white", "scale-125");
            dot.classList.add("bg-white/40");
          }
        });
      }

      function startAutoplay() {
        stopAutoplay();
        if (total <= 1) return;
        interval = setInterval(() => goToSlide((current + 1) % total), 7000);
        (container as any)._heroInterval = interval;
      }

      function stopAutoplay() {
        if (interval) {
          clearInterval(interval);
          interval = undefined;
          (container as any)._heroInterval = undefined;
        }
      }

      let touchStartX = 0;
      container.addEventListener(
        "touchstart",
        (e: any) => {
          touchStartX = e.changedTouches[0].screenX;
        },
        { passive: true },
      );

      container.addEventListener(
        "touchend",
        (e: any) => {
          const touchEndX = e.changedTouches[0].screenX;
          if (Math.abs(touchEndX - touchStartX) > 50) {
            if (touchEndX < touchStartX) goToSlide((current + 1) % total);
            else goToSlide((current - 1 + total) % total);
            startAutoplay();
          }
        },
        { passive: true },
      );

      dots.forEach((dot, idx) => {
        dot.addEventListener("click", () => {
          goToSlide(idx);
          startAutoplay();
        });
      });

      // Initial state
      slides.forEach((slide, i) => {
        gsap.set(slide, { opacity: i === 0 ? 1 : 0, scale: 1 });
      });

      startAutoplay();
    });
  }

  setupHero();
  document.addEventListener("astro:page-load", setupHero);
  document.addEventListener("astro:before-swap", () => {
    document.querySelectorAll("[data-hero-container]").forEach((container) => {
      const interval = (container as any)._heroInterval;
      if (interval) clearInterval(interval);
    });
  });
</script>
