---
import { Plus, Minus } from "@lucide/astro";

const { faqs = [] } = Astro.props;

const defaultFaqs = [
  {
    question: "How much does a handyman cost near me?",
    answer:
      "Johnny Pro Handyman offers competitive rates with transparent pricing in Ogden and surrounding areas. Since every project is unique, I recommend reaching out for a personalized, free estimate. This ensures you get a fair price tailored specifically to your project's needs.",
  },
  {
    question: "Do you offer same-day handyman service in Utah?",
    answer:
      "Yes! I understand that some repairs can't wait. I offer same-day service for urgent repairs throughout Ogden, Salt Lake City, and surrounding Utah areas. Whether it's a leaky faucet, broken door lock, or electrical issue, I prioritize emergency calls and strive to provide prompt, professional service when you need it most.",
  },
  {
    question: "Are you insured and professional?",
    answer:
      "Absolutely. I am fully insured to protect both you and my work, and I am currently in the process of official licensing to further demonstrate my commitment to Utah's standards. I am a trained professional with 15+ years of experience who follows all local building codes and safety regulations in Weber County.",
  },
  {
    question: "What payment methods do you accept?",
    answer:
      "For your convenience, I accept cash and electronic transfers including Venmo and Zelle. Payment is typically due upon completion of the work. I believe in transparent pricing, so you'll always know the cost before I start any project.",
  },
  {
    question: "Do I need to provide materials, or do you supply them?",
    answer:
      "I can work either way. I'm happy to use materials you've already purchased, or I can source high-quality materials for you. I'll find the best solution during your project assessment for TV mounting, plumbing fixtures, or any home repair.",
  },
];

const faqList = faqs.length > 0 ? faqs : defaultFaqs;

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: faqList.map((faq: { question: string; answer: string }) => ({
    "@type": "Question",
    name: faq.question,
    acceptedAnswer: {
      "@type": "Answer",
      text: faq.answer,
    },
  })),
};
---

<script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

<section class="py-20 bg-black faq-section">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16" data-animate-faq-header>
      <h2 class="text-4xl md:text-5xl font-bold text-white mb-4 font-inter">
        Frequently Asked <span class="text-orange-500">Questions</span>
      </h2>
      <p class="text-xl text-gray-400">
        Get answers to common questions about my handyman services
      </p>
    </div>

    <div class="space-y-4" data-faq-container>
      {
        faqList.map(
          (faq: { question: string; answer: string }, index: number) => (
            <div
              class="bg-gray-900/50 border border-white/10 rounded-xl overflow-hidden hover:border-orange-500/50 transition-all"
              data-faq-item
              data-index={index}
            >
              <button
                class="w-full px-6 py-5 flex items-center justify-between text-left group"
                data-faq-button
                aria-expanded="false"
              >
                <span class="text-lg font-semibold text-white group-hover:text-orange-500 transition-colors pr-4">
                  {faq.question}
                </span>
                <div class="shrink-0">
                  <Plus
                    class="w-6 h-6 text-orange-500 transition-transform"
                    data-icon-plus
                  />
                  <Minus
                    class="w-6 h-6 text-orange-500 hidden transition-transform"
                    data-icon-minus
                  />
                </div>
              </button>

              <div
                class="overflow-hidden transition-all duration-300 max-h-0"
                data-faq-answer
              >
                <div class="px-6 pb-5 text-gray-300 leading-relaxed">
                  {faq.answer}
                </div>
              </div>
            </div>
          ),
        )
      }
    </div>
  </div>
</section>

<style>
  [data-animate-faq-header],
  [data-faq-item] {
    opacity: 0;
    transform: translateY(20px);
    visibility: visible;
    transition:
      opacity 0.6s cubic-bezier(0.2, 0.8, 0.2, 1),
      transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .reveal-active[data-animate-faq-header],
  .reveal-active[data-faq-item] {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  import gsap from "gsap";

  function setupFAQ() {
    document.querySelectorAll(".faq-section").forEach((section) => {
      const container = section.querySelector("[data-faq-container]");
      const header = section.querySelector("[data-animate-faq-header]");

      if (!container || !header) return;

      const items = container.querySelectorAll("[data-faq-item]");

      // Setup toggle logic
      items.forEach((item) => {
        const button = item.querySelector("[data-faq-button]");
        const answer = item.querySelector("[data-faq-answer]");
        const iconPlus = item.querySelector("[data-icon-plus]");
        const iconMinus = item.querySelector("[data-icon-minus]");

        if (!button || !answer || !iconPlus || !iconMinus) return;

        const clonedButton = button.cloneNode(true);
        button.replaceWith(clonedButton);
        const newButton = clonedButton as HTMLElement;

        newButton.addEventListener("click", () => {
          const isOpen = newButton.getAttribute("aria-expanded") === "true";

          // Close others
          items.forEach((otherItem) => {
            if (otherItem !== item) {
              const otherBtn = otherItem.querySelector("[data-faq-button]");
              const otherAns = otherItem.querySelector("[data-faq-answer]");
              if (
                otherBtn &&
                otherAns &&
                otherBtn.getAttribute("aria-expanded") === "true"
              ) {
                otherBtn.setAttribute("aria-expanded", "false");
                gsap.to(otherAns, {
                  maxHeight: 0,
                  duration: 0.25,
                  ease: "power2.inOut",
                });
                otherItem
                  .querySelector("[data-icon-plus]")
                  ?.classList.remove("hidden");
                otherItem
                  .querySelector("[data-icon-minus]")
                  ?.classList.add("hidden");
              }
            }
          });

          if (isOpen) {
            newButton.setAttribute("aria-expanded", "false");
            gsap.to(answer, {
              maxHeight: 0,
              duration: 0.25,
              ease: "power2.inOut",
            });
            iconPlus.classList.remove("hidden");
            iconMinus.classList.add("hidden");
          } else {
            newButton.setAttribute("aria-expanded", "true");
            gsap.to(answer, {
              maxHeight: (answer as HTMLElement).scrollHeight,
              duration: 0.25,
              ease: "power2.inOut",
            });
            iconPlus.classList.add("hidden");
            iconMinus.classList.remove("hidden");
          }
        });
      });

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              if (entry.target.hasAttribute("data-animate-faq-header")) {
                entry.target.classList.add("reveal-active");
              } else {
                const items = entry.target.querySelectorAll("[data-faq-item]");
                items.forEach((item, i) => {
                  setTimeout(() => item.classList.add("reveal-active"), i * 50);
                });
              }
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.1 },
      );

      observer.observe(header);
      observer.observe(container);
    });
  }

  setupFAQ();
  document.addEventListener("astro:page-load", setupFAQ);
</script>
