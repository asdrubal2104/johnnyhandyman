---
import type { ImageMetadata } from "astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { ZoomIn, X, Star, ChevronLeft, ChevronRight } from "@lucide/astro";
import { Image } from "astro:assets";
import Breadcrumbs from "@/components/layout/Breadcrumbs.astro";

const imageFiles = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/Works/*.webp",
  { eager: true },
);

const sortedImageFiles = Object.entries(imageFiles).sort(([a], [b]) => {
  const numA = parseInt(a.match(/\d+/)?.[0] || "0");
  const numB = parseInt(b.match(/\d+/)?.[0] || "0");
  return numA - numB;
});

const allImages = sortedImageFiles.map(([_, img], i) => ({
  src: img.default,
  alt: `Johnny Pro Handyman Project ${i + 1} - Utah Home Improvement`,
  id: i + 1,
}));

const ITEMS_PER_PAGE = 12;
const totalPages = Math.ceil(allImages.length / ITEMS_PER_PAGE);
---

<BaseLayout
  title="Gallery - Johnny Pro Handyman Projects | Before & After Photos"
  description="View our portfolio of completed handyman projects in Utah. See the quality of our work in drywall, plumbing, electrical, painting, and carpentry."
>
  <Breadcrumbs />
  <!-- Hero Section -->
  <section class="relative py-20 bg-linear-to-b from-gray-900 to-black">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16">
        <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 font-inter">
          Our <span class="text-orange-500">Work</span>
        </h1>
        <p class="text-xl text-gray-300 max-w-3xl mx-auto">
          Take a look at some of our recent projects. Quality craftsmanship and
          attention to detail in every job.
        </p>
      </div>

      <!-- Gallery Grid Container -->
      <div id="gallery-container" class="min-h-[600px]">
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          id="gallery-grid"
        >
          {
            allImages.map((item, index) => (
              <article
                class="group relative aspect-square rounded-2xl overflow-hidden cursor-pointer gallery-item hidden"
                data-gallery-item
                data-index={index}
                data-page={Math.floor(index / ITEMS_PER_PAGE) + 1}
              >
                <Image
                  src={item.src}
                  alt={item.alt}
                  class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500"
                  width={600}
                  height={600}
                  loading="lazy"
                  decoding="async"
                  quality="mid"
                />

                {/* Simplified Overlay - Icon Only */}
                <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                  <div class="w-16 h-16 bg-orange-500/90 rounded-full flex items-center justify-center backdrop-blur-sm transform scale-50 group-hover:scale-100 transition-transform duration-300">
                    <ZoomIn class="w-8 h-8 text-white" />
                  </div>
                </div>

                {/* Border on hover */}
                <div class="absolute inset-0 border-4 border-orange-500 opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl pointer-events-none" />
              </article>
            ))
          }
        </div>
      </div>

      <!-- Pagination Controls -->
      <div
        class="mt-16 flex justify-center items-center gap-2"
        id="pagination-controls"
      >
        <button
          id="prev-page"
          class="p-2 rounded-lg bg-gray-900 text-white hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          aria-label="Previous page"
        >
          <ChevronLeft class="w-6 h-6" />
        </button>

        <div id="page-numbers" class="flex gap-2">
          {
            Array.from({ length: totalPages }, (_, i) => (
              <button
                class="w-10 h-10 rounded-lg font-bold transition-all page-btn"
                data-page-btn={i + 1}
              >
                {i + 1}
              </button>
            ))
          }
        </div>

        <button
          id="next-page"
          class="p-2 rounded-lg bg-gray-900 text-white hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          aria-label="Next page"
        >
          <ChevronRight class="w-6 h-6" />
        </button>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-20 bg-linear-to-br from-orange-500 to-orange-600">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-4xl md:text-5xl font-bold text-white mb-6 font-inter">
        Ready to Start Your Project?
      </h2>
      <p class="text-xl text-white/90 mb-8">
        Let's make your home improvement vision a reality. Contact us today for
        a estimate.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/contact"
          class="w-full sm:w-auto inline-flex items-center justify-center bg-white text-orange-600 px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all hover:scale-105 active:scale-95"
        >
          Get an Estimate
        </a>
        <a
          href="tel:(863) 266-1866"
          class="w-full sm:w-auto inline-flex items-center justify-center bg-white/10 backdrop-blur-sm border-2 border-white text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-white/20 transition-all"
        >
          Call (863) 266-1866
        </a>
      </div>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div
    id="gallery-lightbox"
    class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300 items-center justify-center p-4"
  >
    <button
      id="lightbox-close"
      class="absolute top-4 right-4 md:top-8 md:right-8 text-white/70 hover:text-white transition-colors z-50 p-2 bg-black/20 rounded-full hover:bg-black/40 backdrop-blur-sm"
    >
      <X class="w-8 h-8 md:w-10 md:h-10" />
    </button>

    <div
      id="lightbox-content"
      class="relative max-w-7xl max-h-[90vh] w-full flex flex-col items-center pointer-events-none transition-all duration-300 scale-95 opacity-0"
    >
      <img
        id="lightbox-image"
        src=""
        alt=""
        class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl pointer-events-auto select-none"
      />
    </div>
  </div>
</BaseLayout>

<script>
  function setupGallery() {
    // Pagination Logic
    let currentPage = 1;
    const itemsPerPage = 12;
    // Get total items from the DOM to ensure we match the generated HTML
    const allItems = document.querySelectorAll(".gallery-item");
    const totalItems = allItems.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);

    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageBtns = document.querySelectorAll("[data-page-btn]");

    function showPage(page: number) {
      currentPage = page;

      // Update items visibility
      allItems.forEach((item) => {
        const itemPage = parseInt(item.getAttribute("data-page") || "1");
        if (itemPage === page) {
          item.classList.remove("hidden");
          // Add a small fade-in animation
          item.animate(
            [
              { opacity: 0, transform: "translateY(10px)" },
              { opacity: 1, transform: "translateY(0)" },
            ],
            {
              duration: 300,
              easing: "ease-out",
              fill: "forwards",
            },
          );
        } else {
          item.classList.add("hidden");
        }
      });

      // Update buttons state
      if (prevBtn) (prevBtn as HTMLButtonElement).disabled = page === 1;
      if (nextBtn)
        (nextBtn as HTMLButtonElement).disabled = page === totalPages;

      // Update page numbers styling
      pageBtns.forEach((btn) => {
        const btnPage = parseInt(btn.getAttribute("data-page-btn") || "1");
        if (btnPage === page) {
          btn.classList.add("bg-orange-500", "text-white", "scale-110");
          btn.classList.remove(
            "bg-gray-800",
            "text-gray-400",
            "hover:bg-gray-700",
          );
        } else {
          btn.classList.remove("bg-orange-500", "text-white", "scale-110");
          btn.classList.add(
            "bg-gray-800",
            "text-gray-400",
            "hover:bg-gray-700",
          );
        }
      });

      // Scroll to top of gallery smoothly
      const galleryContainer = document.getElementById("gallery-container");
      if (galleryContainer) {
        const yOffset = -100; // Offset for header if needed
        const y =
          galleryContainer.getBoundingClientRect().top +
          window.scrollY +
          yOffset;
        window.scrollTo({ top: y, behavior: "smooth" });
      }
    }

    // Initialize Pagination Events
    prevBtn?.addEventListener("click", () => {
      if (currentPage > 1) showPage(currentPage - 1);
    });

    nextBtn?.addEventListener("click", () => {
      if (currentPage < totalPages) showPage(currentPage + 1);
    });

    pageBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const page = parseInt(btn.getAttribute("data-page-btn") || "1");
        showPage(page);
      });
    });

    // Initialize first page
    showPage(1);

    // Lightbox Logic
    const lightbox = document.getElementById("gallery-lightbox");
    const lightboxContent = document.getElementById("lightbox-content");
    const lightboxImg = document.getElementById(
      "lightbox-image",
    ) as HTMLImageElement;
    const closeBtn = document.getElementById("lightbox-close");

    if (!lightbox || !lightboxContent || !lightboxImg || !closeBtn) return;

    function openLightbox(src: string) {
      lightbox!.classList.remove("hidden");
      lightbox!.classList.add("flex");

      requestAnimationFrame(() => {
        lightbox!.classList.remove("opacity-0");
        lightboxContent!.classList.remove("scale-95", "opacity-0");
        lightboxContent!.classList.add("scale-100", "opacity-100");
      });

      lightboxImg!.src = src;
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox!.classList.add("opacity-0");
      lightboxContent!.classList.remove("scale-100", "opacity-100");
      lightboxContent!.classList.add("scale-95", "opacity-0");

      setTimeout(() => {
        lightbox!.classList.remove("flex");
        lightbox!.classList.add("hidden");
        lightboxImg!.src = "";
      }, 300);
      document.body.style.overflow = "";
    }

    allItems.forEach((item) => {
      item.addEventListener("click", () => {
        const img = item.querySelector("img");
        if (img) {
          openLightbox(img.src);
        }
      });
    });

    closeBtn.addEventListener("click", closeLightbox);
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
        closeLightbox();
      }
    });
  }

  // Run all setup
  setupGallery();
  document.addEventListener("astro:page-load", setupGallery);
</script>
